# 第一章 现代身份的九头蛇

智慧不是学校教育的产物，而是终身学习的产物。

-阿尔伯特·爱因斯坦，理论物理学家，来自1954年3月24日的一封信



你已经准备好把你的下一个大的应用想法付诸实践了。您已经花了大量时间研究、开发和完善体系结构、功能、算法和用户体验，并且您很高兴将您的解决方案推向市场。然后你开始考虑用户，并意识到你的应用程序需要一些身份管理！您开始研究创建帐户、验证用户、提供多因素身份验证，并使所有这些工作顺利跨多个设备。这时你开始觉得自己在和九头蛇搏斗，九头蛇是希腊神话中九个头的神兽。当她的头被砍掉的时候，又长了两个。同样，如果你没有一个很好的计划来处理身份管理，那么解决一个身份管理挑战可能会导致更多的挑战。



## 身份挑战



虽然身份管理在理论上是一个简单的概念，但要使其在实践中发挥良好的作用，需要多种因素共同作用。它需要仔细的规划、设计和开发来实现应用程序的身份管理，同时平衡来自业务需求和安全性的无数期望，更不用说需要提供良好的用户体验了。不幸的是，身份管理不是一个一刀切的主张。没有一个我们可以提供的主解决方案适合每一个用例。



举个例子，下面是您可能需要考虑的许多不同挑战中的几个。面向消费者的应用程序的用户可能希望能够使用Facebook这样的社交提供商快速登录。他们甚至可能希望能够使用多个社交提供商登录到您的应用程序，并且仍然被识别为同一个人。您需要优雅地处理这个需求，否则用户可能会放弃你的申请，因为注册和登录很麻烦。另一方面，员工用户需要通过其工作帐户访问公司应用程序，他们希望单点登录的便利性。更重要的是，公司组织通常具有复杂的授权需求（通常基于角色），以管理组织中员工可以执行的操作的权限。具有敏感内容的应用程序可能需要比简单密码更强大的身份验证形式，但这需要确定哪些身份验证形式提供了足够的安全性，同时仍然方便用户。强身份验证有许多选项，从设备上生成的一次性密码到发送到移动电话的推送通知，或者使用私有加密密钥的硬件安全令牌。您需要易于用户采用和使用的解决方案，因为繁琐的解决方案可能会导致用户绕过解决方案或干脆完全放弃应用程序。

如果您提供了多个应用程序，甚至除了您的应用程序之外还提供了一个支持门户，那么您的用户可能需要单次登录，这样他们就可以登录一次并访问多个应用程序。这为用户提供了便利，也为控制身份验证策略提供了独立的位置。但是，身份验证应用程序的网关必须是高度可用的，并且能够比您的应用程序更高的伸缩性；否则，它将突然成为一个障碍，而不是一个门户。如果单点登录阻碍了对应用程序的访问，那么它就不是一个好处！您的应用程序设计可能需要适应来自交付平台的各种约束。在Web上，用户可能希望浏览器重定向到登录页以进行身份验证。相反，本机桌面应用程序的用户可能更喜欢登录流嵌入到应用程序中或利用底层操作系统提供的会话。不同的移动应用程序可能使用不同的方法。有些可能会将您重定向到身份提供程序以进行登录，但有些可能仍会直接在应用程序中提示您输入凭据。你需要权衡不同的方法和方法，为适合应用程序交付平台的用户体验而设计。应用程序的身份管理设计需要回答所有这些问题以及更多问题，同时考虑到应用程序的敏感性并满足所有相关的业务需求。一个例子可能有助于说明错误的身份决策会对用户使用应用程序的体验产生多大的负面影响。

想象一下，你刚刚安装了一个全新的应用程序来查看猫的图片，而查看去程序要求扫描你的身份证和自拍视频，这无疑看起来有点可疑，因为很难想象为什么猫图片应用程序需要您的身份证信息！糟糕的注册和登录体验可能会影响应用程序的可用性和采用率。

另一方面，对于金融业务申请而言，提供必要的身份证信息进行身份验证似乎更为合理，它甚至可能受到监管要求的推动。事实上，录制一段视频来验证你的身份是银行申请贷款额度的用户体验的一部分。

而制作一个猫图片应用程序，一个无摩擦的社交登录可能是完美的解决方案，但是，如果您正在构建一个银行应用程序，则需要更复杂的注册过程、身份验证以及强身份验证。应用程序的身份管理解决方案必须与应用程序的敏感度和类型相匹配。

似乎这还不够，构建应用程序时的另一个主要关注点是管理敏感身份数据处理和保护的隐私法规。随着欧盟（European Union）的GDPR（General Data Privacy Regulation）等法规以及其他地方正在颁布的类似法规的出台，收集或处理用户数据的应用程序必须符合隐私要求，因为如果违反这些要求，可能会招致严厉的处罚。前面几段中概述的挑战只是您在为应用程序设计身份管理时可能面临的一个示例。



## 目标

我们写这本书的目的是介绍如何做好身份管理，这些主要根据我们构建和部署应用程序的经验而来。本书重点是软件应用程序的身份管理方面，如创建帐户、身份验证、API授权、单点登录、帐户管理和注销用户。为了设定现实的期望，身份管理是一个巨大的课题。一本书不能使你成为专家或者涵盖一切。我们讨论的身份协议规范总共超过800页，但它们只代表您需要知道的一部分信息。我们不能指望本书涵盖这些协议的每个方面或每个身份管理用例。我们提供的是做的是一个介绍性概述，帮助您了解典型应用程序项目所需的身份管理的常见方面，三个身份协议的标准如何解决的一些基本用例，以及通过示例程序进一步阐述如何解决一些实际场景中运用身份。



我们将介绍三种流行的身份协议，即OAuth2.0、OIDC和SAML2.0 – 具体来说，每种方法都要解决什么问题，它们是如何工作的，如何实现简单情况下的身份验证和授权请求，以及如何解决问题。我们不能涵盖每个参数或用例，但您应该对每个协议的功能和工作方式有一个基本的了解。

我们希望随本书附带的文本和示例程序能为您提供一个对应用程序开发项目的身份管理的有用概述。我们也希望您能受到启发，进一步探索这个主题，了解更高级的用例和解决方案。适当设计的身份管理解决方案可以简化您的总体体系结构,它允许您的应用程序将某些职责委派给其他组件，并且可以提供用户的单一视图，并统一访问控制以简化访问控制的问题，提供关键的审核功能，等等。

我们围绕身份的生命周期中的事件组织了内容。我们首先讨论了帐户设置，以及一些用户的初始化工作以便他们可以使用您的应用程序的选项。然后我们进入API 授权和身份验证，并概述了目前使用的三种流行协议，即oauth2.0、OpenID Connect（OIDC）和Security Assertion Markup Language（SAML）2.0。

这些章节包括验证用户和处理应用程序和API的授权。在介绍了协议的基本机制之后，我们有一章解释了本书附带的示例程序以及如何使用这些协议。

接下来的章节将介绍用户第一次登录后发生的事情，包括有关会话、单点登录、增强的身份验证形式、帐户管理、注销和取消设置等。如果您的应用程序第一次不能完美地工作，我们包含了一章关于故障排除的指导。我们还分享了可能出现的问题场景的信息，以及我们遇到的一些不寻常的用例。最后，我们简要介绍了法规遵从性以及导致一些非常不幸的违规行为的一些错误。不妨向过去学习！

我们建议按顺序阅读这些章节，至少从第15章开始，因为其中许多章节都是在前面章节的基础上建立起来的。对于一些跳跃式的阅读者，我们特别建议也至少阅读第4章到第9章，因为他们对早期内容的依赖性最大。第15章之后的章节大部分可以按任何顺序阅读。当您需要调试问题时，有关故障排除的第16章将是最相关的。关于不太常见的需求，在项目的早期阅读第18章可能很有价值，因为它可以帮助您确定要包含在计划中的要包含的项目。第17章和第19章涵盖了不同类型的问题，将帮助你计划或避免错误。

在有关OAuth2.0和OIDC的章节中，我们提供了应用程序发出的HTTP请求的示例。我们知道您可能会使用库或SDK来促进此类调用，事实上，我们强烈鼓励您这样做。如果是这样，那么所选实现的语法将不同。但是，虽然每个库或SDK都会不同，但底层调用应该是符合标准规范。当需要对实现进行故障排除时，您可能会使用浏览器工具或调试器来分析所做的调用，并在这一点上，像我们展示的那样分析 HTTP请求对底层应用程序的理解会很有用。即使您只是配置购买的应用程序，了解基本请求和响应也有助于故障排除。

关于命名的一个注意事项是有序的。我们讨论的协议都使用了不同的术语。这使得很难对某些组件使用一致的术语。我们在几种方法之间进行了辩论，最后决定在讨论特定协议的一章中，我们将使用该协议使用的术语，在其他章节中，我们将使用更通用的术语。例如，在OAuth2.0一章中，我们提到了授权服务器；在OIDC一章中，OpenID提供者；在SAML 2.0章节，身份提供者。在其他更一般的章节中，我们使用术语IDP 身份提供者来对用户进行身份验证。在我们的术语中，客户机应用程序是一个例外。跨这些协议的客户机应用程序有许多名称 – 客户、依赖方、服务提供商、客户应用程序。客户和依赖方在某些规范中的含义是不同的。减少混乱 对于初学者，我们选择在整个过程中使用术语“application”，以指通过OAuth 2.0、OIDC或SAML 2.0发出身份验证或API授权请求的应用程序。这并不理想，因为它忽略了一个事实，即用例， OIDC和SAML 2.0客户端可能不是应用程序，而是也可以是其他客户端的提供者。因为我们的重点是介绍， 在基本用例中，为了各章之间的简单性和一致性，我们决定进行这种权衡。我们偶尔使用术语依赖方，其中引用的实体是依赖方，依赖方可以是为其他客户服务的提供商，而不是简单的应用程序。 我们也将终端用户称为简单的用户，因为我们不需要区分不同类型的用户。

## 示例程序

为了补充本文，我们提供了一个使用OIDC和OAuth2.0协议的示例应用程序。第9章解释了示例应用程序以及作为身份管理解决方案的一部分，身份协议是如何使用的。 我们需要像往常一样提出警告。 作为示例代码， 为了简单起见书中的代码示例和示例应用程序省略了各种功能。他们是非生产就绪代码，不应用作生产应用程序的基础。

**问题设计**

为了开始自己的应用程序，我们建议您考虑以下问题，以便阅读以下章节：

身份的需要包含哪些类型用户：员工、客户、合作伙伴；

他们的身份标识是一个或者是多个，如何关联和映射；

不同身份标识对应的认证方式和可信源是什么；

通过何种应用进行接入，是web、api、还是native app；

如果进行服务的访问控制，是否需要根据以上给予不同的授权；

是否需要增强的身份，给予的认证有效期；

多个应用之间的认证是否共享，即SSO；

多个应用之间的身份是否关联等等

否涉及到敏感信息的操作，如有是否符合了法规；

当用户登出式，会发生哪些事件；

如用户ID的统一和映射，根据上下文的动态策略等等。



## 总结

现代用户希望在使用应用程序时获得无摩擦、设计良好的体验。身份管理应该帮助他们快速访问应用程序，而不是妨碍他们。为了实现这一点，开发人员面临许多问题，需要在开发身份管理时对各种可用选项进行排序。下一章将帮助您了解身份管理的组件 通过覆盖身份生命周期的事件来解决问题。



## 关键点



身份管理对现代应用程序的开发人员提出了许多挑战。

•身份管理解决方案必须适合应用程序的敏感性、所需的用户体验和交付平台。

•身份管理是一个庞大的主题，超出了我们的范围 完全在一本书里。

•我们将为您的应用程序提供身份管理概述和身份管理的典型要求。

•我们将介绍三种协议 – 它们的用途、工作方式以及如何发出基本的身份验证或授权请求。

•我们将提供一个示例程序，说明所讨论的一些主题。
